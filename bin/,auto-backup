#! /usr/local/bin/bash
failvar=0;
mount -t ext2fs /dev/ada1s1 /mnt || echo "mount failed" && failvar=1;
cd /mnt || echo "cd failed." && failvar=1;
backupdate=$(date -I) || echo "date set failed" && failvar=1
rm -rf $backupdate-backup/ || echo "directory already exists and rm could not remove." && failvar=1
mkdir $backupdate-backup || echo "mkdir failed." && failvar=1
#mv /home/freebsd/.cache /tmp/freebsd-.cache
tar --exclude='/home/freebsd/.mozilla' --exclude='/home/freebsd/.cache' --exclude='/home/freebsd/linux-isos/*' --exclude='/home/freebsd/coding/building-from-src/*' --exclude='*cache*' -cvf /mnt/$backupdate-backup/full-home-backup.tar /home/freebsd/ # || echo "tar failed" && failvar=1;
tar -cvf /mnt/$backupdate-backup/full-etc-backup.tar /etc # || echo "etc tar failed" && failvar=1
cp /boot/loader.conf /mnt/$backupdate-backup/loader.conf
pkg prime-list >> /mnt/$backupdate-backup/all-installed-pkg.txt || echo "pkg info -aq failed" && failvar=1 #&& exit;
cd / || echo "cd to / failed"  && failvar=1 #&& exit;
#echo "backup completed successfully. backup is stored as \"$backupdate-backup\"."
sed -e ':a' -e 'N' -e '$!ba' -e 's/\n/ /g' /mnt/$backupdate-backup/all-installed-pkg.txt > /mnt/$backupdate-backup/installed-packages.txt || echo "sed failed" && failvar=1
rm /mnt/$backupdate-backup/all-installed-pkg.txt || echo "rm failed" && failvar=1
echo "#! /usr/local/bin/bash" > /mnt/$backupdate-backup/install-all-pkg.sh || echo "cat failed" && failvar=1
echo "cat installed-packages.txt | xargs pkg install" >> /mnt/$backupdate-backup/install-all-pkg.sh || echo "second cat failed"  && failvar=1
chmod a+x /mnt/$backupdate-backup/install-all-pkg.sh || echo "chmod failed" && failvar=1
umount /mnt # || echo "umount failed" && failvar=1 #&& exit;
#if [[ "$failvar" != "1" ]]; 
#then
#	echo "backup completed successfully. backup is stored as \"$backupdate-backup\"."
#else
#	echo "Something went wrong. Read debug lines."
#fi
